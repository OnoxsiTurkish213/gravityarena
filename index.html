<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gravity Arena</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{overflow:hidden;background:#000;font-family:'Segoe UI',sans-serif;color:#fff}
        canvas{display:block;position:fixed;top:0;left:0;z-index:1}

        #crosshair{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:100;pointer-events:none;display:none}
        #crosshair .dot{width:4px;height:4px;background:#fff;border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
        #crosshair .ln{position:absolute;background:rgba(255,255,255,.7)}
        #crosshair .t{width:2px;height:10px;top:-16px;left:50%;transform:translateX(-50%)}
        #crosshair .b{width:2px;height:10px;bottom:-16px;left:50%;transform:translateX(-50%)}
        #crosshair .l{width:10px;height:2px;left:-16px;top:50%;transform:translateY(-50%)}
        #crosshair .r{width:10px;height:2px;right:-16px;top:50%;transform:translateY(-50%)}

        #hud{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:90;display:none}
        #hud-top{display:flex;justify-content:space-between;align-items:flex-start;padding:20px 30px}
        .sbox{background:rgba(0,0,0,.7);border:1px solid rgba(138,43,226,.5);border-radius:10px;padding:10px 18px;backdrop-filter:blur(5px);min-width:140px}
        .sbox.me{border-color:rgba(0,200,255,.6)}
        .sbox .lb{font-size:11px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:1px}
        .sbox .vl{font-size:28px;font-weight:700}
        .sbox.me .vl{color:#00c8ff}
        .sbox.en .vl{color:#ff4466}
        #vs{text-align:center}
        #vs .v{font-size:14px;color:rgba(255,255,255,.3);letter-spacing:4px}
        #vs .tg{font-size:11px;color:rgba(138,43,226,.7);margin-top:4px}

        #hud-bottom{position:absolute;bottom:25px;left:50%;transform:translateX(-50%);display:flex;gap:20px}
        .hbox{background:rgba(0,0,0,.7);border:1px solid rgba(138,43,226,.4);border-radius:10px;padding:8px 18px;text-align:center;backdrop-filter:blur(5px)}
        .hbox .lb{font-size:9px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px}
        .hbox .ic{font-size:22px;margin-top:2px}
        #ammo{font-size:24px;font-weight:700;color:#00ff88}
        #ammo.empty{color:#ff4466}
        #ammo.reload{color:#ffaa00;animation:bk .4s infinite}
        @keyframes bk{0%,100%{opacity:1}50%{opacity:.3}}

        #gflash{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(138,43,226,.3);pointer-events:none;z-index:95;opacity:0;transition:opacity .15s}
        #dmg{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:94;opacity:0;background:radial-gradient(ellipse at center,transparent 40%,rgba(255,0,0,.6) 100%);transition:opacity .3s}
        #hitm{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:101;pointer-events:none;opacity:0;font-size:30px;color:#ff4444;font-weight:900}

        #kfeed{position:fixed;top:80px;right:20px;z-index:91;pointer-events:none}
        .kfm{background:rgba(0,0,0,.75);border-left:3px solid #ff4466;padding:6px 12px;margin-bottom:5px;font-size:12px;border-radius:0 6px 6px 0;animation:kfI .3s ease,kfO .4s ease 2.5s forwards}
        @keyframes kfI{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes kfO{to{opacity:0;transform:translateX(40px)}}

        #instr{position:fixed;bottom:75px;left:20px;z-index:91;pointer-events:none;display:none}
        .ins{display:flex;align-items:center;gap:8px;margin-bottom:4px;font-size:11px;color:rgba(255,255,255,.3)}
        .ins .k{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:3px;padding:1px 6px;font-size:10px}

        #clickplay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:150;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.6);cursor:pointer}
        #clickplay .mg{font-size:24px;color:#fff;animation:bk 1s infinite}
        #clickplay .sb{font-size:13px;color:rgba(255,255,255,.4);margin-top:10px}

        #menu{position:fixed;top:0;left:0;width:100%;height:100%;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0a0a1a,#1a0a2e,#0a1a2e)}
        .bgr{position:absolute;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(rgba(138,43,226,.08) 1px,transparent 1px),linear-gradient(90deg,rgba(138,43,226,.08) 1px,transparent 1px);background-size:50px 50px;animation:ga 20s linear infinite}
        @keyframes ga{to{background-position:50px 50px}}
        .ttl{font-size:64px;font-weight:900;text-transform:uppercase;letter-spacing:8px;background:linear-gradient(135deg,#00c8ff,#8a2be2,#ff44aa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;z-index:1;text-align:center}
        .stl{font-size:15px;color:rgba(255,255,255,.35);letter-spacing:6px;text-transform:uppercase;margin-bottom:40px;z-index:1}
        .mi{background:rgba(255,255,255,.05);border:1px solid rgba(138,43,226,.4);border-radius:10px;padding:12px 20px;color:#fff;font-size:15px;width:300px;margin-bottom:12px;z-index:1;outline:none;text-align:center;transition:border-color .3s}
        .mi:focus{border-color:#00c8ff}
        .mi::placeholder{color:rgba(255,255,255,.25)}
        .mb{background:linear-gradient(135deg,#8a2be2,#6a1fb2);border:none;border-radius:10px;padding:14px 36px;color:#fff;font-size:16px;font-weight:700;cursor:pointer;letter-spacing:2px;text-transform:uppercase;z-index:1;transition:all .3s;margin:6px;min-width:240px}
        .mb:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(138,43,226,.4)}
        .mb.sc{background:linear-gradient(135deg,#1a3a5c,#0a2a4c);border:1px solid rgba(0,200,255,.3)}
        #stxt{margin-top:15px;font-size:13px;color:rgba(255,255,255,.5);z-index:1;min-height:20px;text-align:center}

        #waitscr{position:fixed;top:0;left:0;width:100%;height:100%;z-index:200;display:none;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0a0a1a,#1a0a2e,#0a1a2e)}
        .spin{width:40px;height:40px;border:3px solid rgba(138,43,226,.2);border-top-color:#8a2be2;border-radius:50%;animation:sp 1s linear infinite;margin-bottom:18px}
        @keyframes sp{to{transform:rotate(360deg)}}
        .lcode{font-size:36px;font-weight:900;letter-spacing:10px;color:#00c8ff;background:rgba(0,200,255,.1);border:1px solid rgba(0,200,255,.3);border-radius:10px;padding:12px 28px;margin:12px 0;z-index:1}

        #resscr{position:fixed;top:0;left:0;width:100%;height:100%;z-index:300;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.85);backdrop-filter:blur(8px)}
        #restxt{font-size:56px;font-weight:900;text-transform:uppercase;letter-spacing:6px;margin-bottom:15px}
        #restxt.win{color:#00ff88;text-shadow:0 0 30px rgba(0,255,136,.5)}
        #restxt.lose{color:#ff4466;text-shadow:0 0 30px rgba(255,68,102,.5)}
        #ressco{font-size:22px;color:rgba(255,255,255,.5);margin-bottom:30px}
    </style>
</head>
<body>

<div id="crosshair">
    <div class="dot"></div>
    <div class="ln t"></div><div class="ln b"></div>
    <div class="ln l"></div><div class="ln r"></div>
</div>

<div id="hud">
    <div id="hud-top">
        <div class="sbox me"><div class="lb" id="mname">Sen</div><div class="vl" id="mscore">0</div></div>
        <div id="vs"><div class="v">V S</div><div class="tg">Ä°lk 5'e ulaÅŸan kazanÄ±r</div></div>
        <div class="sbox en"><div class="lb" id="ename">Rakip</div><div class="vl" id="escore">0</div></div>
    </div>
    <div id="hud-bottom">
        <div class="hbox"><div class="lb">YerÃ§ekimi</div><div class="ic" id="gico">â¬‡ï¸</div></div>
        <div class="hbox"><div class="lb">Mermi</div><div id="ammo">1</div></div>
    </div>
</div>

<div id="gflash"></div>
<div id="dmg"></div>
<div id="hitm">âœ•</div>
<div id="kfeed"></div>

<div id="instr">
    <div class="ins"><span class="k">W A S D</span> Hareket</div>
    <div class="ins"><span class="k">FARE</span> BakÄ±ÅŸ</div>
    <div class="ins"><span class="k">SPACE</span> ZÄ±pla</div>
    <div class="ins"><span class="k">E</span> YerÃ§ekimi</div>
    <div class="ins"><span class="k">SOL TIK</span> AteÅŸ</div>
</div>

<div id="clickplay">
    <div class="mg">ğŸ® OYNAMAK Ä°Ã‡Ä°N TIKLA</div>
    <div class="sb">Fare kontrolÃ¼ iÃ§in tÄ±klayÄ±n</div>
</div>

<div id="menu">
    <div class="bgr"></div>
    <div class="ttl">GRAVITY</div>
    <div class="stl">A R E N A</div>
    <input type="text" id="iname" class="mi" placeholder="Oyuncu AdÄ±nÄ±z" maxlength="16">
    <button class="mb" id="bcreate">ğŸ® Lobi OluÅŸtur</button>
    <input type="text" id="icode" class="mi" placeholder="Lobi Kodu" maxlength="6" style="text-transform:uppercase">
    <button class="mb sc" id="bjoin">ğŸ”— Lobiye KatÄ±l</button>
    <div id="stxt"></div>
</div>

<div id="waitscr">
    <div class="bgr"></div>
    <div class="ttl" style="font-size:42px">GRAVITY ARENA</div>
    <div class="spin"></div>
    <div style="font-size:15px;color:rgba(255,255,255,.5);z-index:1;margin-bottom:10px">Rakip bekleniyor...</div>
    <div style="font-size:12px;color:rgba(255,255,255,.35);z-index:1">Lobi Kodu:</div>
    <div class="lcode" id="wcode">-----</div>
    <div style="font-size:11px;color:rgba(255,255,255,.25);z-index:1;margin-top:5px">Bu kodu arkadaÅŸÄ±na gÃ¶nder</div>
    <button class="mb sc" id="bcancel" style="margin-top:25px;min-width:160px;font-size:13px">Ä°ptal</button>
</div>

<div id="resscr">
    <div id="restxt">ZAFER!</div>
    <div id="ressco"></div>
    <button class="mb" id="bback">Ana MenÃ¼</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE - KENDÄ° BÄ°LGÄ°LERÄ°NÄ° GÄ°R
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
firebase.initializeApp({
    apiKey: "AIzaSyDHIFw7LYjMTpRMpe-ONkSm91fdXk4JWY4",
  authDomain: "gravityarena-14578.firebaseapp.com",
  databaseURL: "https://gravityarena-14578-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gravityarena-14578",
  storageBucket: "gravityarena-14578.firebasestorage.app",
  messagingSenderId: "781898977885",
  appId: "1:781898977885:web:a047f4ed10ef296bee73b4",
});
const db = firebase.database();
console.log("[GA] Firebase OK");

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SABÄ°TLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AW=40, AH=16, AD=40;
const MSPD=11, JMPF=8.5, GRV=22, SENS=0.002;
const BSPD=45, MAXBNC=8, BLIFE=6, WINSCORE=5;
const SYNCHZ=1000/25, PH=1.6, PR=0.45;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DURUM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let st='menu', lobId=null, myId=null, myNm='Oyuncu', enNm='Rakip';
let lobRef=null, mySc=0, enSc=0;
let scene, cam, ren, clk;
let pP=new THREE.Vector3(), pV=new THREE.Vector3();
let gDir=-1, onF=false, yaw=0, pitch=0;
let ks={}, pLock=false;
let hasA=true, rldng=false;
let lBul=[], rBul=[], bIdCnt=0, lastRBId=null, procHits={};
let eMesh, eTP=new THREE.Vector3(0,2,10), eRY=0, eGD=-1, eAlive=false;
let lastSyn=0, skAmt=0, skDur=0, skT=0;
let wGrp, wBob=0, ptcls;
let bVFX=[];

const PILLS=[{x:-10,z:-10},{x:10,z:-10},{x:-10,z:10},{x:10,z:10},{x:0,z:-13},{x:0,z:13}];
const PLSZ=1;
const PLT={x:0,y:AH/2,z:0,hw:3,hh:0.5,hd:3};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YARDIMCI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<5;i++)r+=c[Math.floor(Math.random()*c.length)];return r}
function setSt(m){document.getElementById('stxt').textContent=m;console.log('[GA] '+m)}
function sh(id,v){document.getElementById(id).style.display=v}

function showGame(){
    sh('menu','none');sh('waitscr','none');sh('resscr','none');
    sh('hud','block');sh('crosshair','block');sh('instr','block');
    sh('clickplay','flex');
}
function showMenu(){
    sh('menu','flex');sh('waitscr','none');sh('resscr','none');
    sh('hud','none');sh('crosshair','none');sh('instr','none');sh('clickplay','none');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initThree(){
    scene=new THREE.Scene();
    scene.background=new THREE.Color(0x060612);
    scene.fog=new THREE.FogExp2(0x060612,0.012);

    cam=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,200);
    cam.position.set(0,2,0);
    scene.add(cam);

    ren=new THREE.WebGLRenderer({antialias:true});
    ren.setSize(innerWidth,innerHeight);
    ren.setPixelRatio(Math.min(devicePixelRatio,2));
    ren.shadowMap.enabled=true;
    ren.toneMapping=THREE.ACESFilmicToneMapping;
    ren.toneMappingExposure=1.1;
    document.body.prepend(ren.domElement);

    clk=new THREE.Clock();

    buildArena();
    buildLights();
    buildEnemy();
    buildWeapon();
    buildParticles();
    console.log("[GA] Sahne hazÄ±r");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARENA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildArena(){
    const hw=AW/2, hd=AD/2;

    // Zemin
    const fG=new THREE.PlaneGeometry(AW,AD);
    const fM=new THREE.MeshStandardMaterial({color:0x181830,metalness:0.5,roughness:0.5});
    const fl=new THREE.Mesh(fG,fM);fl.rotation.x=-Math.PI/2;fl.receiveShadow=true;scene.add(fl);

    const gr=new THREE.GridHelper(AW,20,0x2a2a50,0x1a1a40);gr.position.y=0.01;scene.add(gr);

    // Tavan
    const cM=new THREE.MeshStandardMaterial({color:0x121225,metalness:0.6,roughness:0.4});
    const cl=new THREE.Mesh(fG.clone(),cM);cl.rotation.x=Math.PI/2;cl.position.y=AH;cl.receiveShadow=true;scene.add(cl);
    const cg=new THREE.GridHelper(AW,20,0x2a2a50,0x1a1a40);cg.position.y=AH-0.01;scene.add(cg);

    // Duvarlar
    const wM=new THREE.MeshStandardMaterial({color:0x10102a,metalness:0.4,roughness:0.6,side:THREE.DoubleSide});
    const wgW=new THREE.PlaneGeometry(AW,AH);
    const wgD=new THREE.PlaneGeometry(AD,AH);

    const w1=new THREE.Mesh(wgW,wM);w1.position.set(0,AH/2,hd);w1.rotation.y=Math.PI;scene.add(w1);
    const w2=new THREE.Mesh(wgW.clone(),wM.clone());w2.position.set(0,AH/2,-hd);scene.add(w2);
    const w3=new THREE.Mesh(wgD,wM.clone());w3.position.set(hw,AH/2,0);w3.rotation.y=-Math.PI/2;scene.add(w3);
    const w4=new THREE.Mesh(wgD.clone(),wM.clone());w4.position.set(-hw,AH/2,0);w4.rotation.y=Math.PI/2;scene.add(w4);

    // Neon kenarlar
    function nM(c,i){return new THREE.MeshStandardMaterial({color:c,emissive:c,emissiveIntensity:i||1.5,metalness:0.8,roughness:0.2})}
    const pur=nM(0x8a2be2), blu=nM(0x00c8ff), pnk=nM(0xff44aa,0.8);

    function tube(a,b,mat,r){
        const s=new THREE.Vector3(...a),e=new THREE.Vector3(...b);
        const p=new THREE.LineCurve3(s,e);
        const g=new THREE.TubeGeometry(p,1,r||0.05,6,false);
        scene.add(new THREE.Mesh(g,mat));
    }

    // Alt
    [[[-hw,0,-hd],[hw,0,-hd]],[[hw,0,-hd],[hw,0,hd]],[[hw,0,hd],[-hw,0,hd]],[[-hw,0,hd],[-hw,0,-hd]]].forEach(e=>tube(e[0],e[1],pur));
    // Ãœst
    [[[-hw,AH,-hd],[hw,AH,-hd]],[[hw,AH,-hd],[hw,AH,hd]],[[hw,AH,hd],[-hw,AH,hd]],[[-hw,AH,hd],[-hw,AH,-hd]]].forEach(e=>tube(e[0],e[1],pur));
    // Dikey
    [[[-hw,0,-hd],[-hw,AH,-hd]],[[hw,0,-hd],[hw,AH,-hd]],[[hw,0,hd],[hw,AH,hd]],[[-hw,0,hd],[-hw,AH,hd]]].forEach(e=>tube(e[0],e[1],blu));
    // Orta
    const mh=AH/2;
    [[[-hw,mh,-hd],[hw,mh,-hd]],[[hw,mh,-hd],[hw,mh,hd]],[[hw,mh,hd],[-hw,mh,hd]],[[-hw,mh,hd],[-hw,mh,-hd]]].forEach(e=>tube(e[0],e[1],pnk,0.03));

    // SÃ¼tunlar
    const pMt=new THREE.MeshStandardMaterial({color:0x1a1a3e,metalness:0.6,roughness:0.4});
    PILLS.forEach(p=>{
        const pg=new THREE.BoxGeometry(2,AH,2);
        const pm=new THREE.Mesh(pg,pMt);pm.position.set(p.x,AH/2,p.z);pm.castShadow=true;pm.receiveShadow=true;scene.add(pm);
        for(let i=1;i<=3;i++){
            const sg=new THREE.BoxGeometry(2.06,0.08,2.06);
            const sm=new THREE.Mesh(sg,nM(0x8a2be2,0.6));sm.position.set(p.x,i*(AH/4),p.z);scene.add(sm);
        }
    });

    // Platform
    const plG=new THREE.BoxGeometry(6,1,6);
    const plM=new THREE.Mesh(plG,new THREE.MeshStandardMaterial({color:0x1a1a3e,metalness:0.7,roughness:0.3}));
    plM.position.set(0,AH/2,0);plM.castShadow=true;plM.receiveShadow=true;scene.add(plM);
    const peG=new THREE.BoxGeometry(6.1,0.06,6.1);
    [0.52,-0.52].forEach(dy=>{
        const pe=new THREE.Mesh(peG,nM(0x00c8ff,1.2));pe.position.set(0,AH/2+dy,0);scene.add(pe);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IÅIKLAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLights(){
    scene.add(new THREE.AmbientLight(0x222244,0.7));
    scene.add(new THREE.HemisphereLight(0x4444aa,0x222222,0.5));
    [[0,AH-1,0,0x8a2be2],[-14,3,-14,0x00c8ff],[14,3,14,0xff44aa],[0,3,0,0x00ff88]].forEach(d=>{
        const pl=new THREE.PointLight(d[3],1.2,35);pl.position.set(d[0],d[1],d[2]);pl.castShadow=true;scene.add(pl);
    });
    const sp=new THREE.SpotLight(0x8a2be2,1.5,40,Math.PI/4,0.5);
    sp.position.set(0,AH-0.5,0);sp.target.position.set(0,0,0);scene.add(sp);scene.add(sp.target);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DÃœÅMAN - CapsuleGeometry YOK, elle yapÄ±yoruz
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildEnemy(){
    eMesh=new THREE.Group();

    // GÃ¶vde - silindir
    const bodyG=new THREE.CylinderGeometry(0.4,0.4,1.0,10);
    const bodyM=new THREE.MeshStandardMaterial({color:0xff4466,emissive:0xff2244,emissiveIntensity:0.3,metalness:0.6,roughness:0.4});
    const body=new THREE.Mesh(bodyG,bodyM);body.castShadow=true;
    eMesh.add(body);

    // Alt yarÄ±kÃ¼re
    const botG=new THREE.SphereGeometry(0.4,10,6,0,Math.PI*2,Math.PI/2,Math.PI/2);
    const botM=new THREE.Mesh(botG,bodyM.clone());
    botM.position.y=-0.5;
    eMesh.add(botM);

    // Ãœst yarÄ±kÃ¼re
    const topG=new THREE.SphereGeometry(0.4,10,6,0,Math.PI*2,0,Math.PI/2);
    const topM=new THREE.Mesh(topG,bodyM.clone());
    topM.position.y=0.5;
    eMesh.add(topM);

    // Kafa
    const headG=new THREE.SphereGeometry(0.3,10,10);
    const head=new THREE.Mesh(headG,new THREE.MeshStandardMaterial({color:0xff6688,emissive:0xff4466,emissiveIntensity:0.4}));
    head.position.y=0.85;head.castShadow=true;
    eMesh.add(head);

    // VizÃ¶r
    const visG=new THREE.BoxGeometry(0.32,0.1,0.14);
    const vis=new THREE.Mesh(visG,new THREE.MeshStandardMaterial({color:0x00c8ff,emissive:0x00c8ff,emissiveIntensity:2.5}));
    vis.position.set(0,0.88,0.25);
    eMesh.add(vis);

    // Glow
    const gl=new THREE.PointLight(0xff4466,0.7,5);gl.position.y=0.5;
    eMesh.add(gl);

    eMesh.visible=false;
    scene.add(eMesh);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SÄ°LAH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildWeapon(){
    wGrp=new THREE.Group();
    const bM=new THREE.MeshStandardMaterial({color:0x333344,metalness:0.8,roughness:0.3});
    wGrp.add(new THREE.Mesh(new THREE.BoxGeometry(0.07,0.07,0.35),bM));

    const br=new THREE.Mesh(new THREE.CylinderGeometry(0.018,0.022,0.22,8),
        new THREE.MeshStandardMaterial({color:0x444455,metalness:0.9,roughness:0.2}));
    br.rotation.x=Math.PI/2;br.position.z=-0.27;wGrp.add(br);

    const tp=new THREE.Mesh(new THREE.SphereGeometry(0.025,8,8),
        new THREE.MeshStandardMaterial({color:0x00ff88,emissive:0x00ff88,emissiveIntensity:2}));
    tp.position.z=-0.38;tp.name='tip';wGrp.add(tp);

    const hd=new THREE.Mesh(new THREE.BoxGeometry(0.05,0.12,0.05),bM.clone());
    hd.position.set(0,-0.08,0.08);hd.rotation.x=-0.2;wGrp.add(hd);

    const sM=new THREE.MeshStandardMaterial({color:0x8a2be2,emissive:0x8a2be2,emissiveIntensity:2});
    [0.038,-0.038].forEach(x=>{
        const s=new THREE.Mesh(new THREE.BoxGeometry(0.004,0.015,0.3),sM);s.position.set(x,0,0);wGrp.add(s);
    });

    wGrp.position.set(0.22,-0.18,-0.35);
    cam.add(wGrp);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTÄ°KÃœLLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildParticles(){
    const n=150,pos=new Float32Array(n*3),col=new Float32Array(n*3);
    for(let i=0;i<n;i++){
        pos[i*3]=(Math.random()-0.5)*AW;pos[i*3+1]=Math.random()*AH;pos[i*3+2]=(Math.random()-0.5)*AD;
        const c=new THREE.Color();c.setHSL(0.7+Math.random()*0.2,0.7,0.5);
        col[i*3]=c.r;col[i*3+1]=c.g;col[i*3+2]=c.b;
    }
    const g=new THREE.BufferGeometry();
    g.setAttribute('position',new THREE.BufferAttribute(pos,3));
    g.setAttribute('color',new THREE.BufferAttribute(col,3));
    ptcls=new THREE.Points(g,new THREE.PointsMaterial({size:0.07,vertexColors:true,transparent:true,opacity:0.4,blending:THREE.AdditiveBlending,depthWrite:false}));
    scene.add(ptcls);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initInput(){
    document.addEventListener('keydown',e=>{
        ks[e.code]=true;
        if(e.code==='KeyE'&&st==='playing') toggleGrav();
    });
    document.addEventListener('keyup',e=>{ks[e.code]=false});

    document.addEventListener('mousemove',e=>{
        if(!pLock||st!=='playing') return;
        yaw-=e.movementX*SENS;
        pitch-=e.movementY*SENS;
        pitch=Math.max(-Math.PI/2.1,Math.min(Math.PI/2.1,pitch));
    });

    document.addEventListener('mousedown',e=>{
        if(e.button===0&&st==='playing'&&pLock) shoot();
    });

    document.addEventListener('pointerlockchange',()=>{
        pLock=document.pointerLockElement===ren.domElement;
        if(pLock){
            sh('clickplay','none');
            document.body.style.cursor='none';
        } else {
            document.body.style.cursor='default';
            if(st==='playing') sh('clickplay','flex');
        }
    });

    document.getElementById('clickplay').addEventListener('click',()=>{
        if(st==='playing') ren.domElement.requestPointerLock();
    });

    ren.domElement.addEventListener('click',()=>{
        if(st==='playing'&&!pLock) ren.domElement.requestPointerLock();
    });

    window.addEventListener('resize',()=>{
        cam.aspect=innerWidth/innerHeight;
        cam.updateProjectionMatrix();
        ren.setSize(innerWidth,innerHeight);
    });

    document.getElementById('bcreate').onclick=createLobby;
    document.getElementById('bjoin').onclick=joinLobby;
    document.getElementById('bcancel').onclick=cancelLobby;
    document.getElementById('bback').onclick=backToMenu;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOBÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createLobby(){
    myNm=document.getElementById('iname').value.trim()||'Oyuncu1';
    lobId=genCode();myId='p1';
    lobRef=db.ref('lobbies/'+lobId);
    setSt('Lobi oluÅŸturuluyor...');

    lobRef.set({
        st:'wait',
        p1:{nm:myNm,x:-8,y:2,z:0,ry:0,rp:0,gd:-1,sc:0,bl:null,ht:null},
        p2:null,
        ts:firebase.database.ServerValue.TIMESTAMP
    }).then(()=>{
        console.log('[GA] Lobi: '+lobId);
        document.getElementById('wcode').textContent=lobId;
        sh('menu','none');sh('waitscr','flex');
        st='waiting';
        waitP2();
    }).catch(e=>setSt('Hata: '+e.message));

    lobRef.onDisconnect().remove();
}

function waitP2(){
    lobRef.child('st').on('value',snap=>{
        if(snap.val()==='go'&&st==='waiting'){
            lobRef.child('p2').once('value').then(s=>{
                const d=s.val();
                if(d){enNm=d.nm||'Rakip';startGame();}
            });
        }
    });
}

function joinLobby(){
    myNm=document.getElementById('iname').value.trim()||'Oyuncu2';
    const code=document.getElementById('icode').value.trim().toUpperCase();
    if(!code||code.length<4){setSt('GeÃ§erli kod girin!');return}

    lobId=code;myId='p2';
    lobRef=db.ref('lobbies/'+lobId);
    setSt('BaÄŸlanÄ±lÄ±yor...');

    lobRef.once('value').then(snap=>{
        const d=snap.val();
        if(!d){setSt('Lobi bulunamadÄ±!');return}
        if(d.st!=='wait'){setSt('Lobi dolu!');return}
        enNm=d.p1.nm||'Rakip';

        lobRef.child('p2').set({
            nm:myNm,x:8,y:2,z:0,ry:Math.PI,rp:0,gd:-1,sc:0,bl:null,ht:null
        }).then(()=>{
            lobRef.child('st').set('go');
            console.log('[GA] KatÄ±ldÄ±: '+lobId);
            startGame();
        });
        lobRef.child('p2').onDisconnect().remove();
    }).catch(e=>setSt('Hata: '+e.message));
}

function cancelLobby(){
    if(lobRef)lobRef.remove();
    lobRef=null;lobId=null;st='menu';showMenu();
}

function backToMenu(){
    if(lobRef)lobRef.remove();
    lobRef=null;lobId=null;st='menu';
    mySc=0;enSc=0;clearBul();eAlive=false;
    showMenu();
    try{document.exitPointerLock()}catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OYUN BAÅLAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(){
    st='playing';
    showGame();

    document.getElementById('mname').textContent=myNm;
    document.getElementById('ename').textContent=enNm;
    document.getElementById('mscore').textContent='0';
    document.getElementById('escore').textContent='0';

    if(myId==='p1'){pP.set(-8,2,0);yaw=0;}
    else{pP.set(8,2,0);yaw=Math.PI;}
    pV.set(0,0,0);gDir=-1;pitch=0;
    mySc=0;enSc=0;hasA=true;rldng=false;
    clearBul();procHits={};lastRBId=null;
    updateGravUI();updateAmmoUI();

    console.log('[GA] Oyun baÅŸladÄ±! '+myNm+' ('+myId+')');
    setupListeners();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE DÄ°NLEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let enListener=null, htListener=null;

function setupListeners(){
    const eId=myId==='p1'?'p2':'p1';

    // Ã–nceki listener'larÄ± temizle
    if(enListener) try{lobRef.child(eId).off('value',enListener)}catch(e){}
    if(htListener) try{lobRef.child(myId+'/ht').off('value',htListener)}catch(e){}

    enListener = lobRef.child(eId).on('value',snap=>{
        const d=snap.val();
        if(!d){eAlive=false;return}
        eAlive=true;
        if(d.x!==undefined) eTP.set(d.x,d.y,d.z);
        if(d.ry!==undefined) eRY=d.ry;
        if(d.gd!==undefined) eGD=d.gd;
        if(d.sc!==undefined){enSc=d.sc;document.getElementById('escore').textContent=enSc}
        if(d.bl) handleRBul(d.bl);
    });

    htListener = lobRef.child(myId+'/ht').on('value',snap=>{
        const d=snap.val();
        if(d&&!procHits[d.id]){
            procHits[d.id]=true;
            gotHit();
            lobRef.child(myId+'/ht').remove();
        }
    });
}

function syncMe(){
    if(!lobRef||st!=='playing') return;
    const now=performance.now();
    if(now-lastSyn<SYNCHZ) return;
    lastSyn=now;

    const u={};
    u[myId+'/x']=Math.round(pP.x*100)/100;
    u[myId+'/y']=Math.round(pP.y*100)/100;
    u[myId+'/z']=Math.round(pP.z*100)/100;
    u[myId+'/ry']=Math.round(yaw*1000)/1000;
    u[myId+'/rp']=Math.round(pitch*1000)/1000;
    u[myId+'/gd']=gDir;
    u[myId+'/sc']=mySc;
    lobRef.update(u);
}

function sendBul(b){
    if(!lobRef)return;
    bIdCnt++;
    lobRef.child(myId+'/bl').set({
        id:myId+'_'+bIdCnt+'_'+Date.now(),
        px:Math.round(b.position.x*100)/100,
        py:Math.round(b.position.y*100)/100,
        pz:Math.round(b.position.z*100)/100,
        dx:Math.round(b.userData.dir.x*1000)/1000,
        dy:Math.round(b.userData.dir.y*1000)/1000,
        dz:Math.round(b.userData.dir.z*1000)/1000
    });
}

function sendHit(){
    if(!lobRef)return;
    const eId=myId==='p1'?'p2':'p1';
    lobRef.child(eId+'/ht').set({id:'h_'+Date.now()+'_'+Math.random(),by:myNm});
}

function handleRBul(d){
    if(!d||d.id===lastRBId)return;
    lastRBId=d.id;
    spawnBul(new THREE.Vector3(d.px,d.py,d.pz),new THREE.Vector3(d.dx,d.dy,d.dz).normalize(),false);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YERÃ‡EKÄ°MÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleGrav(){
    gDir*=-1;onF=false;
    const fl=document.getElementById('gflash');
    fl.style.opacity='1';setTimeout(()=>fl.style.opacity='0',150);
    doShake(0.12,200);
    updateGravUI();
}
function updateGravUI(){document.getElementById('gico').textContent=gDir===-1?'â¬‡ï¸':'â¬†ï¸'}
function doShake(a,d){skAmt=a;skDur=d/1000;skT=0}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ATEÅ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shoot(){
    if(!hasA||rldng)return;
    hasA=false;updateAmmoUI();
    const dir=new THREE.Vector3(0,0,-1);
    dir.applyQuaternion(cam.quaternion).normalize();
    const sp=cam.position.clone().add(dir.clone().multiplyScalar(0.8));
    const b=spawnBul(sp,dir,true);
    sendBul(b);
    console.log('[GA] AteÅŸ!');
}

function spawnBul(pos,dir,local){
    const color=local?0x00ff88:0xff4466;
    const g=new THREE.SphereGeometry(0.1,8,8);
    const m=new THREE.MeshStandardMaterial({color,emissive:color,emissiveIntensity:3});
    const bul=new THREE.Mesh(g,m);bul.position.copy(pos);
    bul.add(new THREE.PointLight(color,1.5,6));

    // Trail
    const tP=[];for(let i=0;i<25;i++)tP.push(pos.x,pos.y,pos.z);
    const tG=new THREE.BufferGeometry();
    tG.setAttribute('position',new THREE.Float32BufferAttribute(tP,3));
    const trail=new THREE.Line(tG,new THREE.LineBasicMaterial({color,transparent:true,opacity:0.5}));
    scene.add(trail);

    bul.userData={dir:dir.clone(),bnc:0,life:0,local,trail,tH:[]};
    scene.add(bul);
    if(local)lBul.push(bul);else rBul.push(bul);
    return bul;
}

function updateAmmoUI(){
    const el=document.getElementById('ammo');
    if(hasA){el.textContent='1';el.className=''}
    else if(rldng){el.textContent='...';el.className='reload'}
    else{el.textContent='0';el.className='empty'}
}
function startReload(){
    if(rldng||hasA)return;
    rldng=true;updateAmmoUI();
    setTimeout(()=>{hasA=true;rldng=false;updateAmmoUI();console.log('[GA] Mermi yenilendi')},1200);
}
function clearBul(){
    [...lBul,...rBul].forEach(b=>{scene.remove(b);if(b.userData.trail)scene.remove(b.userData.trail)});
    lBul=[];rBul=[];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MERMÄ° FÄ°ZÄ°ÄÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateBullets(dt){
    function proc(arr,loc){
        for(let i=arr.length-1;i>=0;i--){
            const b=arr[i];b.userData.life+=dt;
            b.position.addScaledVector(b.userData.dir,BSPD*dt);
            bounceBul(b);
            updateTrail(b);

            if(loc&&eAlive&&b.position.distanceTo(eTP)<1.2){
                hitEnemy();rmBul(b,i,arr);startReload();continue;
            }
            if(b.userData.bnc>MAXBNC||b.userData.life>BLIFE){
                rmBul(b,i,arr);if(loc)startReload();
            }
        }
    }
    proc(lBul,true);proc(rBul,false);
}

function bounceBul(b){
    const p=b.position,d=b.userData.dir;
    const hw=AW/2,hd=AD/2,r=0.1;
    let bn=false;

    if(p.y<r){p.y=r;d.y=Math.abs(d.y);bn=true}
    if(p.y>AH-r){p.y=AH-r;d.y=-Math.abs(d.y);bn=true}
    if(p.x>hw-r){p.x=hw-r;d.x=-Math.abs(d.x);bn=true}
    if(p.x<-hw+r){p.x=-hw+r;d.x=Math.abs(d.x);bn=true}
    if(p.z>hd-r){p.z=hd-r;d.z=-Math.abs(d.z);bn=true}
    if(p.z<-hd+r){p.z=-hd+r;d.z=Math.abs(d.z);bn=true}

    PILLS.forEach(pl=>{
        const dx=p.x-pl.x,dz=p.z-pl.z;
        const ox=(PLSZ+r)-Math.abs(dx),oz=(PLSZ+r)-Math.abs(dz);
        if(ox>0&&oz>0&&p.y>0&&p.y<AH){
            if(ox<oz){d.x=Math.sign(dx)*Math.abs(d.x);p.x+=Math.sign(dx)*ox}
            else{d.z=Math.sign(dz)*Math.abs(d.z);p.z+=Math.sign(dz)*oz}
            bn=true;
        }
    });

    const pl=PLT;
    if(Math.abs(p.x-pl.x)<pl.hw+r&&Math.abs(p.y-pl.y)<pl.hh+r&&Math.abs(p.z-pl.z)<pl.hd+r){
        const ox=(pl.hw+r)-Math.abs(p.x-pl.x);
        const oy=(pl.hh+r)-Math.abs(p.y-pl.y);
        const oz=(pl.hd+r)-Math.abs(p.z-pl.z);
        if(oy<ox&&oy<oz){d.y=Math.sign(p.y-pl.y)*Math.abs(d.y);p.y+=Math.sign(p.y-pl.y)*oy}
        else if(ox<oz){d.x=Math.sign(p.x-pl.x)*Math.abs(d.x);p.x+=Math.sign(p.x-pl.x)*ox}
        else{d.z=Math.sign(p.z-pl.z)*Math.abs(d.z);p.z+=Math.sign(p.z-pl.z)*oz}
        bn=true;
    }

    if(bn){b.userData.bnc++;d.normalize();spawnBVFX(p.clone(),b.userData.local?0x00ff88:0xff4466)}
}

function updateTrail(b){
    if(!b.userData.trail)return;
    b.userData.tH.unshift(b.position.x,b.position.y,b.position.z);
    if(b.userData.tH.length>75)b.userData.tH.length=75;
    const a=b.userData.trail.geometry.attributes.position.array;
    for(let i=0;i<a.length;i++){
        a[i]=b.userData.tH[i]!==undefined?b.userData.tH[i]:b.position.getComponent(i%3);
    }
    b.userData.trail.geometry.attributes.position.needsUpdate=true;
}

function rmBul(b,i,arr){scene.remove(b);if(b.userData.trail)scene.remove(b.userData.trail);arr.splice(i,1)}

function spawnBVFX(pos,color){
    const g=new THREE.SphereGeometry(0.2,6,6);
    const m=new THREE.MeshBasicMaterial({color,transparent:true,opacity:0.7});
    const mesh=new THREE.Mesh(g,m);mesh.position.copy(pos);mesh.userData.born=clk.getElapsedTime();
    scene.add(mesh);bVFX.push(mesh);
}

function updateBVFX(){
    const now=clk.getElapsedTime();
    for(let i=bVFX.length-1;i>=0;i--){
        const v=bVFX[i];const t=now-v.userData.born;
        const s=1+t*4;v.scale.set(s,s,s);v.material.opacity=Math.max(0,0.7-t*3);
        if(t>0.3){scene.remove(v);bVFX.splice(i,1)}
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VURUÅ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hitEnemy(){
    mySc++;document.getElementById('mscore').textContent=mySc;
    showHitM();addKF(myNm+' â†’ '+enNm+'! ğŸ’¥');
    sendHit();
    if(lobRef)lobRef.child(myId+'/sc').set(mySc);
    console.log('[GA] Vurdu! Skor: '+mySc);
    if(mySc>=WINSCORE){
        st='result';
        document.getElementById('restxt').textContent='ZAFER!';
        document.getElementById('restxt').className='win';
        document.getElementById('ressco').textContent=mySc+' - '+enSc;
        sh('resscr','flex');
        try{document.exitPointerLock()}catch(e){}
        if(lobRef)lobRef.child('st').set('end');
    }
}

function gotHit(){
    showDmg();addKF(enNm+' â†’ '+myNm+'! ğŸ’€');
    respawn();console.log('[GA] Vuruldun!');
}

function respawn(){
    const spawns=[[-8,2,-8],[8,2,8],[-8,2,8],[8,2,-8],[0,2,0]];
    const s=spawns[Math.floor(Math.random()*spawns.length)];
    pP.set(s[0],s[1],s[2]);pV.set(0,0,0);gDir=-1;updateGravUI();
    if(enSc>=WINSCORE){
        st='result';
        document.getElementById('restxt').textContent='YENÄ°LDÄ°N!';
        document.getElementById('restxt').className='lose';
        document.getElementById('ressco').textContent=mySc+' - '+enSc;
        sh('resscr','flex');
        try{document.exitPointerLock()}catch(e){}
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI EFEKT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showHitM(){const el=document.getElementById('hitm');el.style.opacity='1';setTimeout(()=>el.style.opacity='0',300)}
function showDmg(){const el=document.getElementById('dmg');el.style.opacity='1';doShake(0.25,350);setTimeout(()=>el.style.opacity='0',500)}
function addKF(msg){
    const el=document.getElementById('kfeed');
    const d=document.createElement('div');d.className='kfm';d.textContent=msg;
    el.appendChild(d);setTimeout(()=>{if(d.parentNode)d.remove()},3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OYUNCU FÄ°ZÄ°ÄÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePlayer(dt){
    if(st!=='playing')return;

    pV.y+=gDir*GRV*dt;

    const fwd=new THREE.Vector3(-Math.sin(yaw),0,-Math.cos(yaw));
    const rgt=new THREE.Vector3(Math.cos(yaw),0,-Math.sin(yaw));
    let mx=0,mz=0;
    if(ks['KeyW']){mx+=fwd.x;mz+=fwd.z}
    if(ks['KeyS']){mx-=fwd.x;mz-=fwd.z}
    if(ks['KeyA']){mx-=rgt.x;mz-=rgt.z}
    if(ks['KeyD']){mx+=rgt.x;mz+=rgt.z}
    const ln=Math.sqrt(mx*mx+mz*mz);
    if(ln>0){mx/=ln;mz/=ln}
    pV.x=mx*MSPD;pV.z=mz*MSPD;

    if(ks['Space']&&onF){pV.y=-gDir*JMPF;onF=false}

    pP.x+=pV.x*dt;pP.y+=pV.y*dt;pP.z+=pV.z*dt;
    collideP();

    cam.position.copy(pP);
    if(skT<skDur){
        skT+=dt;const f=1-(skT/skDur);
        cam.position.x+=(Math.random()-0.5)*skAmt*f;
        cam.position.y+=(Math.random()-0.5)*skAmt*f;
    }
    cam.quaternion.setFromEuler(new THREE.Euler(pitch,yaw,0,'YXZ'));
    syncMe();
}

function collideP(){
    const hw=AW/2-PR,hd=AD/2-PR;
    pP.x=Math.max(-hw,Math.min(hw,pP.x));
    pP.z=Math.max(-hd,Math.min(hd,pP.z));

    if(gDir===-1){
        if(pP.y<PH){pP.y=PH;pV.y=0;onF=true}else onF=false;
        if(pP.y>AH-PR){pP.y=AH-PR;pV.y=0}
    }else{
        if(pP.y>AH-PH){pP.y=AH-PH;pV.y=0;onF=true}else onF=false;
        if(pP.y<PR){pP.y=PR;pV.y=0}
    }

    PILLS.forEach(p=>{
        const dx=pP.x-p.x,dz=pP.z-p.z;
        const ox=(PLSZ+PR)-Math.abs(dx),oz=(PLSZ+PR)-Math.abs(dz);
        if(ox>0&&oz>0){
            if(ox<oz)pP.x+=Math.sign(dx)*ox;
            else pP.z+=Math.sign(dz)*oz;
        }
    });

    const pl=PLT;
    const inX=Math.abs(pP.x-pl.x)<pl.hw+PR;
    const inZ=Math.abs(pP.z-pl.z)<pl.hd+PR;
    if(inX&&inZ){
        const dy=pP.y-pl.y;
        if(gDir===-1){
            if(dy>0&&dy<pl.hh+PH&&pV.y<=0){pP.y=pl.y+pl.hh+PH;pV.y=0;onF=true}
            else if(dy<0&&Math.abs(dy)<pl.hh+PR&&pV.y>0){pP.y=pl.y-pl.hh-PR;pV.y=0}
        }else{
            if(dy<0&&Math.abs(dy)<pl.hh+PH&&pV.y>=0){pP.y=pl.y-pl.hh-PH;pV.y=0;onF=true}
            else if(dy>0&&dy<pl.hh+PR&&pV.y<0){pP.y=pl.y+pl.hh+PR;pV.y=0}
        }
        if(Math.abs(dy)<pl.hh+PH){
            const ox2=(pl.hw+PR)-Math.abs(pP.x-pl.x);
            const oz2=(pl.hd+PR)-Math.abs(pP.z-pl.z);
            if(ox2>0&&oz2>0){
                if(ox2<oz2)pP.x+=Math.sign(pP.x-pl.x)*ox2;
                else pP.z+=Math.sign(pP.z-pl.z)*oz2;
            }
        }
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DÃœÅMAN & SÄ°LAH & PARTÄ°KÃœL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateEnemy(){
    if(!eMesh)return;
    if(!eAlive){eMesh.visible=false;return}
    eMesh.visible=true;
    eMesh.position.lerp(eTP,0.2);
    eMesh.rotation.y=eRY;
    eMesh.scale.y=eGD===1?-1:1;
}

function updateWeapon(dt){
    if(!wGrp)return;
    const mv=ks['KeyW']||ks['KeyS']||ks['KeyA']||ks['KeyD'];
    wBob+=dt*(mv&&onF?8:1.5);
    const bx=Math.sin(wBob)*(mv?0.008:0.002);
    const by=Math.sin(wBob*2)*(mv?0.006:0.001);
    wGrp.position.set(0.22+bx,-0.18+by,-0.35);

    const tp=wGrp.getObjectByName('tip');
    if(tp){
        if(hasA){tp.material.color.setHex(0x00ff88);tp.material.emissive.setHex(0x00ff88);tp.material.emissiveIntensity=2+Math.sin(clk.getElapsedTime()*3)*0.5}
        else{tp.material.color.setHex(0xff4444);tp.material.emissive.setHex(0xff4444);tp.material.emissiveIntensity=0.5}
    }
}

function updatePtcls(){
    if(!ptcls)return;
    const a=ptcls.geometry.attributes.position.array;const t=clk.getElapsedTime();
    for(let i=0;i<a.length;i+=3){
        a[i+1]+=Math.sin(t+i)*0.002;
        if(a[i+1]>AH)a[i+1]=0;if(a[i+1]<0)a[i+1]=AH;
    }
    ptcls.geometry.attributes.position.needsUpdate=true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANA DÃ–NGÃœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gameLoop(){
    requestAnimationFrame(gameLoop);
    const dt=Math.min(clk.getDelta(),0.05);

    if(st==='playing'){
        updatePlayer(dt);
        updateEnemy();
        updateBullets(dt);
        updateWeapon(dt);
        updatePtcls();
        updateBVFX();
    }

    ren.render(scene,cam);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BAÅLAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init(){
    console.log('[GA] BaÅŸlatÄ±lÄ±yor...');
    initThree();
    initInput();
    showMenu();
    gameLoop();
    console.log('[GA] HazÄ±r!');
}

window.addEventListener('load',init);
</script>
</body>
</html>
